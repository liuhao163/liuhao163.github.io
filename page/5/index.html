<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="励志当好厨子的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="liuhao163.github.io">
<meta property="og:url" content="https://liuhao163.github.io/page/5/index.html">
<meta property="og:site_name" content="liuhao163.github.io">
<meta property="og:description" content="励志当好厨子的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="liuhao163.github.io">
<meta name="twitter:description" content="励志当好厨子的程序员">



  <link rel="alternate" href="/atom.xml" title="liuhao163.github.io" type="application/atom+xml">




  <link rel="canonical" href="https://liuhao163.github.io/page/5/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>liuhao163.github.io – 杂七杂八</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">liuhao163.github.io</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">杂七杂八</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>Sitemap</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://liuhao163.github.io/异步化于缓存原则/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu hao">
      <meta itemprop="description" content="励志当好厨子的程序员">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuhao163.github.io">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/异步化于缓存原则/" class="post-title-link" itemprop="url">异步化与缓存原则</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-21 09:22:57" itemprop="dateCreated datePublished" datetime="2020-06-21T09:22:57Z">2020-06-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-09-21 15:03:02" itemprop="dateModified" datetime="2022-09-21T15:03:02Z">2022-09-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读后感/" itemprop="url" rel="index"><span itemprop="name">读后感</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读后感/企业IT架构转型之道/" itemprop="url" rel="index"><span itemprop="name">企业IT架构转型之道</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="接口异步"><a href="#接口异步" class="headerlink" title="接口异步"></a>接口异步</h2><p>当业务打到一定规模后，接口串行是性能的一大杀手，因为它：</p>
<ul>
<li>影响用户体验：一个接口往往会至少调用3~5个甚至更多的服务，对于用户的访问会有极大的延迟。</li>
<li>降低系统吞吐：比如一个大的事务或者请求往往会长时间占用链接当业务高峰来了后会占用很多链接无法释放，导致请求排队。</li>
</ul>
<p>接口的异步化往往是解决这种问题的利器，我们可以使用一些带有顺序消费能力的消息队列来解决这种问题。我们实际开发中往往是将一个大事务通过MQ等手段异步拆成多个小事务来增大并发。</p>
<h2 id="分布式事务的数据一致性"><a href="#分布式事务的数据一致性" class="headerlink" title="分布式事务的数据一致性"></a>分布式事务的数据一致性</h2><p>  分布式服务必然会带来数据一致性的问题，和事务的CAID相比，基本遵循俩个原则</p>
<h3 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h3><p>C:一致性<br>A:高可用性<br>P:发生故障好，保证分区可用</p>
<p>分布式事务往往无法完全严格实现CAP，一般是保证P的基础上实现C、A。</p>
<h3 id="BASE理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h3><p>是CAP的一种延展</p>
<p>BA：基本可用，对应的是降级<br>S：柔性状态，即允许当前数据存在中间状态，比如mysql同步时候各从库的数据可能不一致<br>E：最终一致性，即一段时间之后数据会达成最终一致</p>
<h3 id="俩阶段提交"><a href="#俩阶段提交" class="headerlink" title="俩阶段提交"></a>俩阶段提交</h3><p>  原始的分布式事务采用XA俩阶段提交。分为俩个接口：</p>
<ul>
<li>XT：客户端–&gt;事务管理器，负责开始事务、提交事务、回滚事务</li>
<li><p>XA：一般是资源管理器和事务之间交互，比如回滚，提交等。</p>
<p>在这个协议下整个事务的流程是这样的：</p>
<ol>
<li>客户端开启事务;</li>
<li>客户端操作事务中多个资源管理器（mysql）这时候数据已经持久化</li>
<li>客户端提交事务<ol>
<li>第一阶段：prepare，事务管理器去轮询各资源管理器检查状态，返回 READY,NOT_READY,READY_ONLY，</li>
<li>第二阶段：commit or rollback，根据第一节阶段的结果进行rollbacck（NOT_READY）或者commit（READY）。</li>
</ol>
</li>
</ol>
</li>
</ul>
<h3 id="分布式系统–柔性事务"><a href="#分布式系统–柔性事务" class="headerlink" title="分布式系统–柔性事务"></a>分布式系统–柔性事务</h3><p>  上面的方案在传统项目中是可以的，但是在互联网应用中，这种项目因为锁的存在会极大的降低性能。</p>
<h4 id="通过日志来进行业务补偿"><a href="#通过日志来进行业务补偿" class="headerlink" title="通过日志来进行业务补偿"></a>通过日志来进行业务补偿</h4><p>  事务日志：记录事务的开始，事务参于者，状态。保存在事物管理器<br>  undo/redolog：用于发生异常后为了实现最终一致性，进行重试( <strong>正想补充 redolog</strong> ) 或者回滚 （ <strong>反向补偿 undolog</strong> ）</p>
<h4 id="可靠消息传递"><a href="#可靠消息传递" class="headerlink" title="可靠消息传递"></a>可靠消息传递</h4><p>  防止在网路错误时候出现消息丢失情况，我们要实现，<strong>at least once</strong>：即消息可能投递多次</p>
<p>  主要幂等性：同一条数据执行多次后，结果不能发生改变。实现方案是采用排重表。【如：可能有多条插入数据库的消息，我们应该只能写入一条记录这种是幂等行，解决方案可能会采用一个排重列表，过滤掉重复的消息】</p>
<h4 id="无锁设计"><a href="#无锁设计" class="headerlink" title="无锁设计"></a>无锁设计</h4><p>  减少锁开销</p>
<ol>
<li>表面事务回滚，没有回滚则没有锁</li>
<li>通过辅助表取代热点数据的修改。如，秒杀系统的库存的预减</li>
<li>乐观锁</li>
</ol>
<h3 id="阿里的实践"><a href="#阿里的实践" class="headerlink" title="阿里的实践"></a>阿里的实践</h3><h4 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h4><p>具体叫rocketmq的实践，先发一个half-message给mq此时对消费者即远端事务透明，生产者完成本地事务提交给mq，mq在将事务发给消费者。</p>
<p>兜底策略：如果mq长期没有half-message的ack,mq会主动问询生产者状态，来确认事务是进一步进行还是丢弃。</p>
<p>缺点：仅适用于俩个参与者，仅能提供正向补偿。</p>
<h4 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h4><p>为了解决多参与者以及实现反向补偿（rollback），在支付宝场景下实现了TCC(try confirm cancel)</p>
<ul>
<li>try:对资源的检验、锁定，实现软隔离</li>
<li>confirm:事务的真正提交过程，只用try阶段锁定的资源。</li>
<li>cancel:取消回滚</li>
</ul>
<p>tcc只提供了框架，真正的资源回滚还需要业务方自己通过代码进行回滚。</p>
<h4 id="TXC"><a href="#TXC" class="headerlink" title="TXC"></a>TXC</h4><p>新一大分布式事务处理框架，他是通过在db层上实现了比较薄的代理来实现分布式事物。</p>
<ul>
<li>TXC用来开启(register)一个事务，分配一个txid</li>
<li>之后所有的对db的请求会先通过txc-rm这个代理，他负责解析sql语句如果遇到Insert/delete/update会生成undolog和redolog</li>
<li>自动回滚：当有回滚需求时候<ul>
<li>校验当前数据库的值和redolog是否一致，如果一致通过undolog回滚</li>
<li>如果不一致，说明别的进程和事务已经修改了数据库，这时候回滚可能会导致数据不一致，只能同构redolog进行重试补偿。</li>
</ul>
</li>
</ul>
<h3 id="缓存的使用"><a href="#缓存的使用" class="headerlink" title="缓存的使用"></a>缓存的使用</h3><p>  以大促为例，阿里采用自己开发的Tair作为缓存，我们可以使用redis的方案。</p>
<p>  以秒杀场景为例，看下缓存的作用：</p>
<p>  首先要做服务集群的隔离</p>
<h4 id="小库存的秒杀场景"><a href="#小库存的秒杀场景" class="headerlink" title="小库存的秒杀场景"></a>小库存的秒杀场景</h4><ol>
<li>商品详情页的缓存降低数据查询压力</li>
<li>库存校验的的条件判断：在下单前判断库存是否还足够</li>
<li>下单时候用乐观锁来修改库存</li>
</ol>
<h4 id="大库存热点商品的秒杀"><a href="#大库存热点商品的秒杀" class="headerlink" title="大库存热点商品的秒杀"></a>大库存热点商品的秒杀</h4><p>  这种情况不适合用乐观锁的原因是锁所冲突很大，并且会出现后下单的反而抢到了商品情况。</p>
<p>  我们这时候在下单时候，可以按照如下逻辑，注意括号中的备注</p>
<blockquote>
<p>预订单对用户不可见(用于缓存崩溃等情况恢复用的快照)–&gt;发送消息给mq（保证下订单的顺序）–&gt; 缓存中扣减库存（事务交给缓存）–&gt;修改订单状态，完单。</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://liuhao163.github.io/数据库拆分实现业务线性能力扩展/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu hao">
      <meta itemprop="description" content="励志当好厨子的程序员">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuhao163.github.io">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/数据库拆分实现业务线性能力扩展/" class="post-title-link" itemprop="url">数据库拆分实现业务线性能力扩展</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-17 11:00:30" itemprop="dateCreated datePublished" datetime="2020-06-17T11:00:30Z">2020-06-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-09-21 15:03:02" itemprop="dateModified" datetime="2022-09-21T15:03:02Z">2022-09-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读后感/" itemprop="url" rel="index"><span itemprop="name">读后感</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读后感/企业IT架构转型之道/" itemprop="url" rel="index"><span itemprop="name">企业IT架构转型之道</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在业务达到一定规模后，由于数据库是中心架构的，一个设计糟糕的数据库将会给业务带来非常严重的灾难，这方面阿里提出了很多宝贵的经验和方法论。</p>
<h2 id="阿里数据库的分布式方案"><a href="#阿里数据库的分布式方案" class="headerlink" title="阿里数据库的分布式方案"></a>阿里数据库的分布式方案</h2><ol>
<li>垂直拆分：根据不同的业务以高内聚、低耦合的原则，将数据拆分到不同的数据库中</li>
<li>读写分离：垂直拆分后有些服务的请求量依然很大，我们首先想到的是读/写分离，因为往往业务场景决定这读远远大于写，这时候进行读写分离可以有效降低写的压力，且从库可以追加多个</li>
<li>分库分表：读写分离无法解决单表写的性能问题，以及单表数据量大的问题，针对这个问题我们可以采用水平分库/表的方案，根绝业务特点对表、库进行水平拆分，分表可以减小单表数据量，分库可以减少单库连接数的上线，从而满足业务的需求。</li>
</ol>
<p>阿里开发了TDDL，作为数据库的拆分方案，特点是：全面支持jdbc，对业务无侵入。</p>
<ol>
<li>matrix：根据业务配置分表规则针对sql语句进行解析，选择需要执行的groupDS</li>
<li>groupDS：负责读写分离，以及根据权重选择atomDS；</li>
<li>atomDs:持有数据库的原子链接；</li>
</ol>
<h2 id="数据库分表的原则"><a href="#数据库分表的原则" class="headerlink" title="数据库分表的原则"></a>数据库分表的原则</h2><ol>
<li>数据尽量均匀：防止数据倾斜；</li>
<li>减少事务边界：尽量减少违反分表分库规则的事务，否则需要进行全表扫描，因为需要在内存中进行聚合，就会降低系统性能，且系统的性能指标就降为单库的指标。</li>
<li>异构索引表来满足跨表查询的场景；</li>
<li><p>提供其他搜索方案来解决复杂的查询、搜索场景；</p>
<p>其中异构索引表，大部分小企业可以采用业务来解决，阿里提供了精卫系统在系统层面来解决数据同步需求：</p>
</li>
<li><p>原理是消费binlog，通过配置进行过滤，同步；</p>
</li>
<li>支持多线程同时同步，为了保证数据在并发情况的一致性，同一条语句根据规则打到同一个线程执行；</li>
<li>强大的UI工具支持；</li>
<li><p>数据的安全性：</p>
<ol>
<li>采用zookeeper做调度、管控；</li>
<li>手动主从切换、宕机回复；</li>
</ol>
<p>PS：</p>
<p>数据库分表分数据遇到了”数据均匀”，”减少事务边界”这两种情况冲突的情况，应该优先解决数据均匀的问题，因为减少事务边界可以采用异构索引表的方式解决。</p>
<p>实际开发中我们采用82原则，针对80%的情况下有20%的场景出现没有分表字段的情况，采用异构索引的方式处理，其他小概率的查询我们可以全表扫描等方案。</p>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://liuhao163.github.io/共享中心建设原则/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu hao">
      <meta itemprop="description" content="励志当好厨子的程序员">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuhao163.github.io">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/共享中心建设原则/" class="post-title-link" itemprop="url">共享中心建设原则</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-16 23:35:46" itemprop="dateCreated datePublished" datetime="2020-06-16T23:35:46Z">2020-06-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-09-21 15:03:02" itemprop="dateModified" datetime="2022-09-21T15:03:02Z">2022-09-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读后感/" itemprop="url" rel="index"><span itemprop="name">读后感</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读后感/企业IT架构转型之道/" itemprop="url" rel="index"><span itemprop="name">企业IT架构转型之道</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>中台不是一成不变的要能跟这业务一起成长，提供多样的接口，作为业务的沉淀</p>
<h2 id="共享服务考量指标"><a href="#共享服务考量指标" class="headerlink" title="共享服务考量指标"></a>共享服务考量指标</h2><ul>
<li>设计：遵循面向对象的原则<br>运营：中台要切实能够解决业务问题，业务能够运营</li>
<li><ul>
<li>工程：在做拆分时候要考虑投入的成本</li>
</ul>
</li>
</ul>
<h2 id="建设中台的几个原则"><a href="#建设中台的几个原则" class="headerlink" title="建设中台的几个原则"></a>建设中台的几个原则</h2><ol>
<li>高内聚，低耦合</li>
<li>数据完整性</li>
<li>业务可运营性</li>
<li>循序渐进</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://liuhao163.github.io/中台演进之路/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu hao">
      <meta itemprop="description" content="励志当好厨子的程序员">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuhao163.github.io">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/中台演进之路/" class="post-title-link" itemprop="url">中台演进之路</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-15 22:56:43" itemprop="dateCreated datePublished" datetime="2020-06-15T22:56:43Z">2020-06-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-09-21 15:03:02" itemprop="dateModified" datetime="2022-09-21T15:03:02Z">2022-09-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读后感/" itemprop="url" rel="index"><span itemprop="name">读后感</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读后感/企业IT架构转型之道/" itemprop="url" rel="index"><span itemprop="name">企业IT架构转型之道</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>与大部分企业的服务化的演进之路如初一辙</p>
<h2 id="单体应用阶段"><a href="#单体应用阶段" class="headerlink" title="单体应用阶段"></a>单体应用阶段</h2><p>单体应用，所有的服务跑在一个war包中，这个war包200多MB。之后遇到了如下的问题</p>
<ol>
<li>数据库的链接到了瓶颈：因为所有的程序在一个war包中，这个工程的数据库连接池非常大，已经逼近了单机数据库的连接池的上限；</li>
<li>所有功能耦合在一起：牵一发而懂全身，很可能一个小改动就引起宕机;</li>
<li>性能问题：没法做业务的隔离，一个接口慢，会拖垮整个项目</li>
<li>业务膨胀导致没有一个人能了解所有的代码，祖传代码盛行。</li>
</ol>
<h2 id="服务化"><a href="#服务化" class="headerlink" title="服务化"></a>服务化</h2><p>飞行中换发动机，采用去中心化的分布式架构逐步用服务替换掉单体应用。</p>
<h3 id="淘宝的微服务化"><a href="#淘宝的微服务化" class="headerlink" title="淘宝的微服务化"></a>淘宝的微服务化</h3><p>  淘宝采用去中心化的微服务架构。与之相对的是中心化架构，著名的“ESB”架构，这个架构有个致命的问题，ESB作为真个架构的路由，所有的服务都会落在ESB上，那么他就会成为整个系统的瓶颈，维护成本很高，并且会制约业务发展。这些是互联网业务无法容忍的，所以淘宝就采用了HSF这种去中心化的分布式架构，服务直接点对点的直接调用。（它的特点naming服务只做服务发现、订阅和配置更新的推送，在服务之间大量的请求并没有走naming）。</p>
<p>  这种架构也就是现在的微服务架构，因为它：</p>
<ol>
<li>以服务方式提供应用</li>
<li>以服务的方式而非项目的方式组织架构</li>
<li>通过服务的只能编排提供业务支撑</li>
<li><p>智能运维，以及健壮的平台稳定性（降级、限流、熔断）</p>
<p>当然微服务话我们也要接受如下挑战：</p>
</li>
<li><p>服务的管控：服务的配置中心，服务的全链路跟踪等需要支持否则排错，自我运维闭环是无法实现的；</p>
</li>
<li>分布式事务的支持：与单体不同，对于数据一致性要求高的场景我们要想办法支持分布式事务的场景;</li>
<li>只能运维的支持以及平台稳定性挑战;</li>
<li>组织架构的变化：要根据服务特点组织组织架构的变化;</li>
</ol>
<h2 id="演进史"><a href="#演进史" class="headerlink" title="演进史"></a>演进史</h2><p>建立共享服务中心，前期根据业务拆分了4个中心用户中心，商品中心，交易中心，店铺中心。</p>
<h3 id="用户中心"><a href="#用户中心" class="headerlink" title="用户中心"></a>用户中心</h3><p>改造成本低相较于其他模块功能简单，受益巨大上游调用次数多，所以是很好的🕙。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://liuhao163.github.io/为什么要构建中台/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu hao">
      <meta itemprop="description" content="励志当好厨子的程序员">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuhao163.github.io">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/为什么要构建中台/" class="post-title-link" itemprop="url">为什么要构建中台</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-10 23:33:18" itemprop="dateCreated datePublished" datetime="2020-06-10T23:33:18Z">2020-06-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-09-21 15:03:02" itemprop="dateModified" datetime="2022-09-21T15:03:02Z">2022-09-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读后感/" itemprop="url" rel="index"><span itemprop="name">读后感</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读后感/企业IT架构转型之道/" itemprop="url" rel="index"><span itemprop="name">企业IT架构转型之道</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="为什么要有中台"><a href="#为什么要有中台" class="headerlink" title="为什么要有中台"></a>为什么要有中台</h2><p>  由于企业的业务不断发展，出现很多功能重复的系统，导致整个技术部门烟囱临立的情况。</p>
<p>  <strong>烟囱的危害具体有</strong></p>
<ul>
<li>功能重复导致资源浪费，道理不说了。</li>
<li>打通不同系统的成本很高，不同的系统，数据、业务都是独立的，想打通需要耗费很大的精力，并且之后的修改很有可能牵一发而动全身。</li>
<li>由于数据、业务分散在不同的系统中，这种无法收敛的状态也不利于公司的技术、业务沉淀，比如：随着业务的发展，A业务原有的系统无法满足，如果没有中台那么A就很有可能在开发一套新的系统，抛弃原有的系统。如果有中台就可以通过中台不断迭代，甚至有可能复用给其他的业务。</li>
</ul>
<p><strong>搭建一个合格的中台的条件</strong></p>
<ul>
<li>首先，来自于企业和团队的决心，耐心。我们都知道阿里巴巴的中台策略很出名，原因在于整个集团对于共享服务的态度，要求业务部门必须接入共享服务中心，哪怕初期功能在简陋、在粗糙，否则搭建的中台就是另一个又昂贵，又脱离业务的新烟囱。</li>
<li>其次，中台的开发者要深入到业务当中，对现有的不同部门、团队的业务进行抽象提取共性，以服务重用的目标来建立、思考中台，而不是简单的将服务打通，堆积在一起。</li>
<li>再次，中台的开发者要有长期迭代的心态，不是上线这个项目或者这个服务就完了。上线这个项目才仅仅是迈出这个中台服务的第一步。后续的迭代成长才是关键。</li>
</ul>
<p><strong>搭建中台的具体好处</strong></p>
<ul>
<li>便于业务的创新：每个业务都只是从自己业务的角度看待问题，但是如果从中台的角度看待问题，横跨多个业务，在整合的过程中可能碰撞出新的想法。</li>
<li>快速迭代、业务试错：supercell和阿里巴巴的大中台小前台策略，可以保证在最小的资源投入前提下进行快速的试错。</li>
<li>数据打通：真正体现大数据的威力，并且懂业务的人才：因为如果还是传统项目制度，研发只会关注现有功能开发和维护，而不会从业务方面思考问题，通过构建中台，研发更加贴近业务会去思考技术如何更好的为业务服务。</li>
<li>改变组织形式提高效能：从自上而下的流失组织架构，改为以共享服务为中心的小团队协作。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://liuhao163.github.io/系统优化-方法论-分析问题的套路总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu hao">
      <meta itemprop="description" content="励志当好厨子的程序员">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuhao163.github.io">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/系统优化-方法论-分析问题的套路总结/" class="post-title-link" itemprop="url">系统优化-方法论-分析问题的套路总结</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-07 19:44:52" itemprop="dateCreated datePublished" datetime="2020-06-07T19:44:52Z">2020-06-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-09-21 15:03:02" itemprop="dateModified" datetime="2022-09-21T15:03:02Z">2022-09-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机基础/" itemprop="url" rel="index"><span itemprop="name">计算机基础</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机基础/方法论/" itemprop="url" rel="index"><span itemprop="name">方法论</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="系统资源瓶颈"><a href="#系统资源瓶颈" class="headerlink" title="系统资源瓶颈"></a>系统资源瓶颈</h2><h3 id="CPU-性能分析"><a href="#CPU-性能分析" class="headerlink" title="CPU 性能分析"></a>CPU 性能分析</h3><p><img src="/系统优化-方法论-分析问题的套路总结/cpu.png" alt="avator"></p>
<h4 id="CPU优化思路"><a href="#CPU优化思路" class="headerlink" title="CPU优化思路"></a>CPU优化思路</h4><p>从这几个方面出发，我相信你已经想到了很多的优化方法。这里，我主要强调一下，最典型的三种优化方法。</p>
<ol>
<li>把进程绑定到一个或者多个 CPU 上，充分利用 CPU 缓存的本地性，并减少进程间的相互影响。</li>
<li>为中断处理程序开启多 CPU 负载均衡，以便在发生大量中断时，可以充分利用多 CPU 的优势分摊负载。</li>
<li>使用 Cgroups 等方法，为进程设置资源限制，避免个别进程消耗过多的 CPU。同时，为核心应用程序设置更高的优先级，减少低优先级任务的影响。</li>
</ol>
<h3 id="内存-性能分析"><a href="#内存-性能分析" class="headerlink" title="内存 性能分析"></a>内存 性能分析</h3><p><img src="/系统优化-方法论-分析问题的套路总结/mem.png" alt="avator"></p>
<h4 id="内存优化思路"><a href="#内存优化思路" class="headerlink" title="内存优化思路"></a>内存优化思路</h4><ol>
<li>除非有必要，Swap 应该禁止掉。这样就可以避免 Swap 的额外 I/O ，带来内存访问变慢的问题。</li>
<li>使用 Cgroups 等方法，为进程设置内存限制。这样就可以避免个别进程消耗过多内存，而影响了其他进程。对于核心应用，还应该降低 oom_score，避免被 OOM 杀死。</li>
<li>使用大页、内存池等方法，减少内存的动态分配，从而减少缺页异常。</li>
</ol>
<h3 id="磁盘IO-性能分析"><a href="#磁盘IO-性能分析" class="headerlink" title="磁盘IO 性能分析"></a>磁盘IO 性能分析</h3><p><img src="/系统优化-方法论-分析问题的套路总结/io.png" alt="avator"></p>
<h4 id="磁盘IO-优化思路"><a href="#磁盘IO-优化思路" class="headerlink" title="磁盘IO 优化思路"></a>磁盘IO 优化思路</h4><ol>
<li>也是最简单的方法，通过 SSD 替代 HDD、或者使用 RAID 等方法，提升 I/O 性能。</li>
<li>针对磁盘和应用程序 I/O 模式的特征，选择最适合的 I/O 调度算法。比如，SSD 和虚拟机中的磁盘，通常用的是 noop 调度算法；而数据库应用，更推荐使用 deadline 算法。</li>
<li>优化文件系统和磁盘的缓存、缓冲区，比如优化脏页的刷新频率、脏页限额，以及内核回收目录项缓存和索引节点缓存的倾向等等</li>
</ol>
<h3 id="网络-性能分析"><a href="#网络-性能分析" class="headerlink" title="网络 性能分析"></a>网络 性能分析</h3><p><img src="/系统优化-方法论-分析问题的套路总结/nat.png" alt="avator"></p>
<p>而要分析网络的性能，自然也是要从这几个协议层入手，通过使用率、饱和度以及错误数这几类性能指标，观察是否存在性能问题。比如 ：</p>
<ul>
<li>在链路层，可以从网络接口的吞吐量、丢包、错误以及软中断和网络功能卸载等角度分析；</li>
<li>在网络层，可以从路由、分片、叠加网络等角度进行分析；</li>
<li>在传输层，可以从 TCP、UDP 的协议原理出发，从连接数、吞吐量、延迟、重传等角度进行分析；</li>
<li>在应用层，可以从应用层协议（如 HTTP 和 DNS）、请求数（QPS）、套接字缓存等角度进行分析。</li>
</ul>
<h4 id="网络-优化思路"><a href="#网络-优化思路" class="headerlink" title="网络 优化思路"></a>网络 优化思路</h4><ol>
<li>你可以增大套接字缓冲区、连接跟踪表、最大半连接数、最大文件描述符数、本地端口范围等内核资源配额；</li>
<li>也可以减少 TIMEOUT 超时时间、SYN+ACK 重传数、Keepalive 探测时间等异常处理参数；</li>
<li>还可以开启端口复用、反向地址校验，并调整 MTU 大小等降低内核的负担。</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://liuhao163.github.io/系统优化-方法论-如何建立监控体系/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu hao">
      <meta itemprop="description" content="励志当好厨子的程序员">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuhao163.github.io">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/系统优化-方法论-如何建立监控体系/" class="post-title-link" itemprop="url">系统优化-方法论-如何建立监控体系</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-07 19:04:42" itemprop="dateCreated datePublished" datetime="2020-06-07T19:04:42Z">2020-06-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-09-21 15:03:02" itemprop="dateModified" datetime="2022-09-21T15:03:02Z">2022-09-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机基础/" itemprop="url" rel="index"><span itemprop="name">计算机基础</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机基础/方法论/" itemprop="url" rel="index"><span itemprop="name">方法论</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我们如何建立有效的监控体系？我们可以从俩个维度来看，系统指标，应用指标。</p>
<h2 id="系统指标"><a href="#系统指标" class="headerlink" title="系统指标"></a>系统指标</h2><p>在开始监控系统之前，你肯定最想知道，怎么才能用简洁的方法，来描述系统资源的使用情况。不过不要忘记，每种资源的性能指标可都有很多，使用过多指标本身耗时耗力不说，也不容易为你建立起系统整体的运行状况。在这里，我为你介绍一种专门用于性能监控的 USE（Utilization Saturation and Errors）法。USE 法把系统资源的性能指标，简化成了三个类别，即使用率、饱和度以及错误数。</p>
<ul>
<li>使用率，表示资源用于服务的时间或容量百分比。100% 的使用率，表示容量已经用尽或者全部时间都用于服务。</li>
<li>饱和度，表示资源的繁忙程度，通常与等待队列的长度相关。100% 的饱和度，表示资源无法接受更多的请求。</li>
<li>错误数表示发生错误的事件个数。错误数越多，表明系统的问题越严重。</li>
</ul>
<p><img src="/系统优化-方法论-如何建立监控体系/use.png" alt="avator"></p>
<p>工具有:zabix，Prometheus等</p>
<p><img src="/系统优化-方法论-如何建立监控体系/prometheus.png" alt="avator"></p>
<h2 id="应用指标"><a href="#应用指标" class="headerlink" title="应用指标"></a>应用指标</h2><p>应用指标可以直观的反应出服务的运行状况，我们更关注，请求数，延迟，错误率等，分布式系统、微服务还需要把握整个请求链路。</p>
<ul>
<li>全链路分析：掌握整个请求链路的响应时间、成功率，有zipkin,还有各大公司的trace方案</li>
<li>指标分析：还需要对重点的业务，逻辑字日志中大点进行监控，解决方案可以采用：elk或者efk。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://liuhao163.github.io/系统优化-方法论-解决系统的吞吐/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu hao">
      <meta itemprop="description" content="励志当好厨子的程序员">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuhao163.github.io">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/系统优化-方法论-解决系统的吞吐/" class="post-title-link" itemprop="url">系统优化-方法论-排查系统吞吐下降的问题</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-07 17:16:32" itemprop="dateCreated datePublished" datetime="2020-06-07T17:16:32Z">2020-06-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-09-21 15:03:02" itemprop="dateModified" datetime="2022-09-21T15:03:02Z">2022-09-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机基础/" itemprop="url" rel="index"><span itemprop="name">计算机基础</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机基础/方法论/" itemprop="url" rel="index"><span itemprop="name">方法论</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>接文章[/系统优化-案例分析-网络丢包分析]</p>
<p>当服务的请求数变大时候，我们往往发现系统吞吐下降。排查思路如下：</p>
<h2 id="优化连接数"><a href="#优化连接数" class="headerlink" title="优化连接数"></a>优化连接数</h2><p>用ss命令发现estab的很少，timewait很多。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ss -s</span><br><span class="line">查看</span><br><span class="line">TCP:   53 (estab 9, closed 38, orphaned 0, synrecv 0, timewait 38/0), ports 0</span><br></pre></td></tr></table></figure>
<p>通过dmsg命令，查看系统的error信息排查是否是conntrack的问题。通过修改参数来解决。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dmsg |tail</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看最大值</span></span><br><span class="line">sysctl net.netfilter.nf_conntrack_max</span><br><span class="line"><span class="comment">#查看当前值</span></span><br><span class="line">sysctl net.netfilter.nf_conntrack_count</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置最大值</span></span><br><span class="line">sysctl -w net.netfilter.nf_conntrack_max</span><br></pre></td></tr></table></figure>
<h2 id="排查应用问题"><a href="#排查应用问题" class="headerlink" title="排查应用问题"></a>排查应用问题</h2><p>比如nginx和tomcat等我们可以查看应用错误的原因，因为大部分采用master+worker的方案，我们可以增加worker的进程</p>
<h2 id="排查tcp方面的原因"><a href="#排查tcp方面的原因" class="headerlink" title="排查tcp方面的原因"></a>排查tcp方面的原因</h2><p>用netstat -s|grep tcp 查看丢包原因，如果发现丢包原因是socket overflowed，则用ss -ltnp命令看下Linsterner端口的队列情况,增大backlog相关的参数。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss -ltnp</span><br></pre></td></tr></table></figure>
<h2 id="优化端口范围"><a href="#优化端口范围" class="headerlink" title="优化端口范围"></a>优化端口范围</h2><p>如果出现类似这样的错误，我们可以看下是否是端口范围过小导致没法创建新连接</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(99: Cannot assign requested address)</span><br><span class="line"></span><br><span class="line">sysctl net.ipv4.ip_local_port_range</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://liuhao163.github.io/系统优化-案例分析-如何定位软中断问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu hao">
      <meta itemprop="description" content="励志当好厨子的程序员">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuhao163.github.io">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/系统优化-案例分析-如何定位软中断问题/" class="post-title-link" itemprop="url">系统优化-案例分析-如何定位软中断问题</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-06 15:16:37" itemprop="dateCreated datePublished" datetime="2020-06-06T15:16:37Z">2020-06-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-09-21 15:03:02" itemprop="dateModified" datetime="2022-09-21T15:03:02Z">2022-09-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机基础/" itemprop="url" rel="index"><span itemprop="name">计算机基础</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机基础/案例分析/" itemprop="url" rel="index"><span itemprop="name">案例分析</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="内核线程"><a href="#内核线程" class="headerlink" title="内核线程"></a>内核线程</h2><p>linux系统有几个进程号比较小的进程</p>
<ul>
<li>0号进程：idel进程用来初始化1号进程和2号进程</li>
<li>1号进程：systemd进程也叫init进程，用来初始化所有的用户进程</li>
<li>2号进程：kthreadd，在内核态运行，用来管理内核线程</li>
</ul>
<p>常见的几个内核线程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ ps -f --ppid 2 -p 2</span><br><span class="line">UID         PID   PPID  C STIME TTY          TIME CMD</span><br><span class="line">root          2      0  0 12:02 ?        00:00:01 [kthreadd]</span><br><span class="line">root          9      2  0 12:02 ?        00:00:21 [ksoftirqd/0]</span><br><span class="line">root         10      2  0 12:02 ?        00:11:47 [rcu_sched]</span><br><span class="line">root         11      2  0 12:02 ?        00:00:18 [migration/0]</span><br><span class="line">...</span><br><span class="line">root      11094      2  0 14:20 ?        00:00:00 [kworker/1:0-eve]</span><br><span class="line">root      11647      2  0 14:27 ?        00:00:00 [kworker/0:2-cgr]</span><br></pre></td></tr></table></figure>
<ul>
<li>ksoftirqd:软中断线程</li>
<li>kworker:用于执行内核工作队列，分为绑定 CPU （名称格式为 kworker/CPU86330）和未绑定 CPU（名称格式为 kworker/uPOOL86330）两类</li>
<li>migration:在负载均衡过程中，把进程迁移到 CPU 上。每个 CPU 都有一个 migration 内核线程。</li>
</ul>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>场景准备：俩台服务器，服务器一运行docker，服务器二压力机，</p>
<p>服务器一：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 运行Nginx服务并对外开放80端口</span></span><br><span class="line">$ docker run -itd --name=nginx -p 80:80 nginx</span><br></pre></td></tr></table></figure>
<p>服务器二发压命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sync_flood攻击</span></span><br><span class="line">$ hping3 -S -p 80 -i u10 192.168.1.2</span><br></pre></td></tr></table></figure>
<p>这时候服务器变慢，top观察如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ top</span><br><span class="line">top - 08:31:43 up 17 min,  1 user,  load average: 0.00, 0.00, 0.02</span><br><span class="line">Tasks: 128 total,   1 running,  69 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu0  :  0.3 us,  0.3 sy,  0.0 ni, 66.8 id,  0.3 wa,  0.0 hi, 32.4 si,  0.0 st</span><br><span class="line">%Cpu1  :  0.0 us,  0.3 sy,  0.0 ni, 65.2 id,  0.0 wa,  0.0 hi, 34.5 si,  0.0 st</span><br><span class="line">KiB Mem :  8167040 total,  7234236 free,   358976 used,   573828 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  7560460 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">    9 root      20   0       0      0      0 S   7.0  0.0   0:00.48 ksoftirqd/0</span><br><span class="line">   18 root      20   0       0      0      0 S   6.9  0.0   0:00.56 ksoftirqd/1</span><br><span class="line"> 2489 root      20   0  876896  38408  21520 S   0.3  0.5   0:01.50 docker-containe</span><br><span class="line"> 3008 root      20   0   44536   3936   3304 R   0.3  0.0   0:00.09 top</span><br><span class="line">    1 root      20   0   78116   9000   6432 S   0.0  0.1   0:11.77 systemd</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<p>cpu的idel下降，si很高，且进程ksoftirqd占用比较高，初步判断软中断出现了问题，我们之前通过sar和vmstat抓包去看，现在我们可以通过perf家火焰图工具查看，使用方法如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装 FlameGraph</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/brendangregg/FlameGraph</span><br><span class="line"><span class="built_in">cd</span> FlameGraph</span><br><span class="line"></span><br><span class="line"><span class="comment">#录制</span></span><br><span class="line">perf record -a -g -p 9 -- sleep 30</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成火焰图</span></span><br><span class="line">perf script -i perf.data|./stackcollapse-perf.pl --all|./flamegraph.pl &gt;flame.svg</span><br></pre></td></tr></table></figure>
<p>生成的火焰图如下：</p>
<p><img src="/系统优化-案例分析-如何定位软中断问题/flame.svg" alt="avator"></p>
<h2 id="动态分析"><a href="#动态分析" class="headerlink" title="动态分析"></a>动态分析</h2><p>工具如图</p>
<p><img src="/系统优化-案例分析-如何定位软中断问题/img1.png" alt="avator"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://liuhao163.github.io/系统优化-案例分析-网络丢包分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu hao">
      <meta itemprop="description" content="励志当好厨子的程序员">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuhao163.github.io">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/系统优化-案例分析-网络丢包分析/" class="post-title-link" itemprop="url">系统优化-案例分析-网络丢包分析</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-05 16:31:04" itemprop="dateCreated datePublished" datetime="2020-06-05T16:31:04Z">2020-06-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-09-21 15:03:02" itemprop="dateModified" datetime="2022-09-21T15:03:02Z">2022-09-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机基础/" itemprop="url" rel="index"><span itemprop="name">计算机基础</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机基础/案例分析/" itemprop="url" rel="index"><span itemprop="name">案例分析</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="优化思路"><a href="#优化思路" class="headerlink" title="优化思路"></a>优化思路</h2><p>见图：</p>
<p><img src="/系统优化-案例分析-网络丢包分析/img0.png" alt="avator"></p>
<p>应用层：应用程序错误<br>Socket：读写缓冲区溢出。排查方案，查看socket参数，抓包<br>TCP：资源或者链接跟踪超限。排查方案，netstat -s<br>IP：MTU获取路由错误。排查方案，netstat -i<br>网络链路层：QoSor校验错误。排查方案，tc<br>网卡：网络拥塞，DMA的ringBuffer溢出。排查方案，netstat -i，抓包</p>
<h2 id="案例排查链路"><a href="#案例排查链路" class="headerlink" title="案例排查链路"></a>案例排查链路</h2><h3 id="看网络包收发状态"><a href="#看网络包收发状态" class="headerlink" title="看网络包收发状态"></a>看网络包收发状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@nginx:/<span class="comment"># netstat -i</span></span><br><span class="line">Kernel Interface table</span><br><span class="line">Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg</span><br><span class="line">eth0       100      106      0     32 0            43      0      0      0 BMRU</span><br><span class="line">lo       65536        0      0      0 0             0      0      0      0 LRU</span><br></pre></td></tr></table></figure>
<h3 id="查看QoS策略"><a href="#查看QoS策略" class="headerlink" title="查看QoS策略"></a>查看QoS策略</h3><p>如下有一个丢包30%的策略删除之</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@nginx:/<span class="comment"># tc -s qdisc show dev eth0</span></span><br><span class="line">qdisc netem 8001: root refcnt 2 <span class="built_in">limit</span> 1000 loss 30%</span><br><span class="line"> Sent 2450 bytes 43 pkt (dropped 18, overlimits 0 requeues 0)</span><br><span class="line"> backlog 0b 0p requeues 0</span><br><span class="line"></span><br><span class="line"><span class="comment">##删除策略</span></span><br><span class="line">root@nginx:/<span class="comment"># tc qdisc del dev eth0 root netem loss 30%</span></span><br></pre></td></tr></table></figure>
<h3 id="看tcp收发情况"><a href="#看tcp收发情况" class="headerlink" title="看tcp收发情况"></a>看tcp收发情况</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root@nginx:/<span class="comment"># netstat -s</span></span><br><span class="line">Ip:</span><br><span class="line">    Forwarding: 1          //开启转发</span><br><span class="line">    31 total packets received    //总收包数</span><br><span class="line">    0 forwarded            //转发包数</span><br><span class="line">    0 incoming packets discarded  //接收丢包数</span><br><span class="line">    25 incoming packets delivered  //接收的数据包数</span><br><span class="line">    15 requests sent out      //发出的数据包数</span><br><span class="line">Icmp:</span><br><span class="line">    0 ICMP messages received    //收到的ICMP包数</span><br><span class="line">    0 input ICMP message failed    //收到ICMP失败数</span><br><span class="line">    ICMP input histogram:</span><br><span class="line">    0 ICMP messages sent      //ICMP发送数</span><br><span class="line">    0 ICMP messages failed      //ICMP失败数</span><br><span class="line">    ICMP output histogram:</span><br><span class="line">Tcp:</span><br><span class="line">    0 active connection openings  //主动连接数</span><br><span class="line">    0 passive connection openings  //被动连接数</span><br><span class="line">    11 failed connection attempts  //失败连接尝试数</span><br><span class="line">    0 connection resets received  //接收的连接重置数</span><br><span class="line">    0 connections established    //建立连接数</span><br><span class="line">    25 segments received      //已接收报文数</span><br><span class="line">    21 segments sent out      //已发送报文数</span><br><span class="line">    4 segments retransmitted    //重传报文数</span><br><span class="line">    0 bad segments received      //错误报文数</span><br><span class="line">    0 resets sent          //发出的连接重置数</span><br><span class="line">Udp:</span><br><span class="line">    0 packets received</span><br><span class="line">    ...</span><br><span class="line">TcpExt:</span><br><span class="line">    11 resets received <span class="keyword">for</span> embryonic SYN_RECV sockets  //半连接重置数</span><br><span class="line">    0 packet headers predicted</span><br><span class="line">    TCPTimeouts: 7    //超时数</span><br><span class="line">    TCPSynRetrans: 4  //SYN重传数</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<h3 id="查看iptables"><a href="#查看iptables" class="headerlink" title="查看iptables"></a>查看iptables</h3><p>查看各种链的策略</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -nvL  ip是数字 verbose list [--line-number-]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除策略</span></span><br><span class="line">iptables -t filter -D [INPUT or OUTPUT 等链名] [line-number]</span><br></pre></td></tr></table></figure>
<h3 id="注意MTU的大小"><a href="#注意MTU的大小" class="headerlink" title="注意MTU的大小"></a>注意MTU的大小</h3><p>hping3 -S通过，但是http访问依然，原因可能和MTU有关，排查后调整</p>
<blockquote>
<p>curl: (28) Operation timed out after 3005 milliseconds with 0 bytes received</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@nginx:/<span class="comment"># netstat -i</span></span><br><span class="line">Kernel Interface table</span><br><span class="line">Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg</span><br><span class="line">eth0       100      106      0     32 0            43      0      0      0 BMRU</span><br><span class="line">lo       65536        0      0      0 0             0      0      0      0 LRU</span><br><span class="line"></span><br><span class="line"><span class="comment">##调整</span></span><br><span class="line">root@nginx:/<span class="comment"># ifconfig eth0 mtu 1500</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Liu hao</p>
              <p class="site-description motion-element" itemprop="description">励志当好厨子的程序员</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">229</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">54</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">81</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/liuhao163" title="GitHub &rarr; https://github.com/liuhao163" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:liu67224657@qq.com" title="E-Mail &rarr; mailto:liu67224657@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu hao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.0.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>



  

  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>


  
  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
